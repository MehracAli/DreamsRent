@using DreamsRentBack.Entities.CarModels;
@using DreamsRentBack.Entities.ClientModels;
@using DreamsRentBack.Utilities;
@model Company
@{
    ViewData["Title"] = "My Account";
    List<Car> cars = ViewBag.Cars;
    List<Rating> ratings = ViewBag.Ratings;
    List<City> cities = ViewBag.Cities;
    List<Street> streets = ViewBag.Streets;
}
@section Scripts{

    <script>

        let changePhotoBtn = document.querySelector(".edit-photo")
        let changePhotoInput = document.querySelector(".change-photo-input")

        changePhotoBtn.addEventListener("click", function(){
            changePhotoInput.click()
        })

        changePhotoInput.addEventListener("change", function(){

            var file = this.files[0]

            if (!file.type.startsWith("image/")) {
                alert("Please select an image file.");
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert("The selected image exceeds the maximum allowed size of 5MB.");
                return;
            }

            document.querySelector("#changePhotoForm").submit();
        })

    </script>
}
<style>

    .no-spinner::-webkit-inner-spin-button,
    .no-spinner::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .no-spinner {
        -moz-appearance: textfield;
    }

    .location-pool{
        border: 2px solid #f2f2f2;
        border-radius:5px;
        width: 100%;
        padding: 10px;
        min-height: 100px;
    }

</style>
<!-- main start -->
<main>
    <section id="account">
        <div class="container">
            <div class="profile row">
                <div class="col-lg-3">
                    <div class="photo" style="display:flex;justify-content:center;align-items:center;background:white;">
                        @if (Model.CompanyPhoto is not null)
                        {
                            <img src="~/assets/images/users/@Model.CompanyPhoto" alt="">
                        }
                        else
                        {
                            <img src="~/assets/images/users/Default_pfp.svg.png" alt="">
                        }
                        <form id="changePhotoForm" asp-action="ChangeCompanyPhoto" asp-route-Id="@Model.Id" enctype="multipart/form-data">
                            <input asp-for="iff_CompanyPhoto" style="display:none;" class="change-photo-input" accept="image/*"/>
                        </form>
                    </div>
                    @if (User.Identity.Name == Model.User.UserName)
                    {    
                        <div class="edit-photo">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </div>
                    }
                </div>
                <div class="fullname col-lg-9">
                    <h1>@Model.CompanyName</h1>
                    <h4>Company</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-3">
                    <div class="side-bar">
                        <ul class="bar-list">
                            <li id="account-detail">
                                Account Details
                            </li>
                            <li id="li-announcements" class="active-li">
                                Announcements
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-9" style="min-height: 300px;">
                    <div class="company-main-side">
                        <div class="account-details">
                            <div class="consumer-account account-details active-main">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="person-info">
                                            <h3>Company Info</h3>
                                            <div class="info-body">
                                                <p style="font-weight:800;">Company Name: <span style="font-weight:400;">@Model.CompanyName</span></p>
                                                <p style="font-weight:800;">Email: <span style="font-weight:400;">@Model.User.Email</span></p>
                                                <p style="font-weight:800;">Phone Number: <span style="font-weight:400;">@Model.User.PhoneNumber</span></p>
                                            </div>
                                            @if (User.Identity.Name == Model.User.UserName)
                                            {
                                                <a href="#" type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#staticBackdrop" style="color:white">
                                                    <i class="fa-solid fa-pen"></i>
                                                    Edit
                                                </a>
                                                <div class="modal fade" id="staticBackdrop" style="backdrop-filter:blur(10px);" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h1 class="modal-title fs-5" id="staticBackdropLabel">Edit Account</h1>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form asp-action="ChangeCompanyDetails" asp-route-Id="@Model.Id" class="row" style="padding: 0 30px">
                                                                <div class="modal-body">
                                                                        <div class="form-group" style="margin-bottom:25px">
                                                                            <label style="margin-bottom:5px">Company Name <span style="color:red">*</span></label>
                                                                            <input asp-for="CompanyName" class="col-lg-12 form-control" />
                                                                        </div>
                                                                        <div class="form-group" style="margin-bottom:25px">
                                                                            <label style="margin-bottom:5px">Email <span style="color:red">*</span></label>
                                                                            <input type="email" name="email" value="@Model.User.Email" class="col-lg-12 form-control" />
                                                                        </div>
                                                                        <div class="form-group" style="margin-bottom:25px">
                                                                            <label style="margin-bottom:5px">Phone Number <span style="color:red">*</span></label>
                                                                            <input type="number" name="phone" value="@Model.User.PhoneNumber" class="no-spinner col-lg-12 form-control" />
                                                                        </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
                                                                    <button type="submit" class="btn btn-warning" style="color:white">Save</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="consumer-account account-details active-main">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="pickup-pool" style="margin-bottom:50px;">
                                            <div class="row" style="margin-bottom:15px">
                                                <div class="col-lg-6">
                                                    <h3>Pickup Locations</h3>
                                                </div>
                                                <div class="col-lg-6 d-flex justify-content-end">
                                                    <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#staticBackdrop2">
                                                        Add Location
                                                    </button>
                                                </div>
                                                <div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h1 class="modal-title fs-5" id="staticBackdropLabel">Add Pickup Location</h1>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form asp-action="AddPickupLocation" asp-route-Id="@Model.Id">
                                                                <div class="modal-body">
                                                                    <div>
                                                                        <label>Choose City</label>
                                                                        <select name="cityId" class="form-control">
                                                                            @foreach (City city in cities)
                                                                            {
                                                                                <option value="@city.Id">
                                                                                    @city.Name
                                                                                </option>
                                                                            }
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label>Choose street</label>
                                                                        <select id="selectOptions" name="streetId" class="form-control">
                                                                            @foreach (Street street in streets)
                                                                            {
                                                                                <option value="@street.Id">
                                                                                    @street.Name
                                                                                </option>
                                                                            }
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
                                                                    <button type="submit" class="btn btn-warning" style="color:white;">Add</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="location-pool"> 
                                                @foreach (CompanyPickupLocation companyPickupLocation in Model.companyPickupLocations)
                                                {
                                                    @foreach (Street street in streets)
                                                    {
                                                        if (street.Id == companyPickupLocation.PickupLocation.StreetId)
                                                        {
                                                            <span style="font-size:13px; color:gray;">@companyPickupLocation.PickupLocation.City.Name, @street.Name; </span>
                                                        }
                                                    };
                                                }
                                            </div>
                                        </div>
                                        <div class="dropoff-pool">
                                            <div class="row" style="margin-bottom:15px">
                                                <div class="col-lg-6">
                                                    <h3>Dropoff Locations</h3>
                                                </div>
                                                <div class="col-lg-6 d-flex justify-content-end">
                                                    <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#staticBackdrop1">
                                                        Add Location
                                                    </button>
                                                </div>
                                                <div class="modal fade" id="staticBackdrop1" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h1 class="modal-title fs-5" id="staticBackdropLabel">Add Dropoff Location</h1>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <form asp-action="AddDropoffLocation" asp-route-Id="@Model.Id">
                                                                <div class="modal-body">
                                                                    <div>
                                                                        <label>Choose City</label>
                                                                        <select name="cityId" class="form-control">
                                                                            @foreach (City city in cities)
                                                                            {
                                                                                <option value="@city.Id">
                                                                                    @city.Name
                                                                                </option>
                                                                            }
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label>Choose street</label>
                                                                        <select id="selectOptions" name="streetId" class="form-control">
                                                                            @foreach (Street street in streets)
                                                                            {
                                                                                <option value="@street.Id">
                                                                                    @street.Name
                                                                                </option>
                                                                            }
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>
                                                                    <button type="submit" class="btn btn-warning" style="color:white;">Add</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="location-pool">
                                                @foreach (CompanyDropoffLocation companyDropoffLocation in Model.companyDropoffLocations)
                                                {
                                                    @foreach (Street street in streets)
                                                    {
                                                        if (street.Id == companyDropoffLocation.DropoffLocation.StreetId)
                                                        {
                                                            <span style="font-size:13px; color:gray;">@companyDropoffLocation.DropoffLocation.City.Name, @street.Name; </span>
                                                        }
                                                    };
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="about-announcements active-main">
                            <div class="company-main-head">
                                <ul>
                                    <li class="announcements-head active-li">Announcements <span>(@Model.Cars.Count())</span></li>
                                    @if (User.Identity.Name == Model.User.UserName)
                                    {
                                        <li class="pending-head">Pending <span>(@Model.Cars.Where(c=>c.CarStatus == CarStatus.Pending).Count())</span></li>
                                        <li class="rented-head">Rented <span>(@Model.Cars.Where(c=>c.CarStatus == CarStatus.Rented).Count())</span></li>
                                    }
                                </ul>
                            </div>
                            <div class="company-main-body">
                                <div class="announcements-body">
                                    @if(Model.Cars == null)
                                    {
                                        <p>Announcements is empty</p>
                                        <a asp-controller="Car" asp-action="AddCar" class="btn">
                                            <i class="fa-solid fa-circle-plus"></i>
                                            Add Car
                                        </a>
                                    }
                                    <div class="row">
                                        @foreach (Car car in Model.Cars)
                                        {
                                            @foreach (Car VBcar in  cars)
                                            {
                                                @if(VBcar.Id == car.Id)
                                                {
                                                    <div class="car-item">
                                                        <div class="card">
                                                            <div class="img-details">
                                                                <div class="card-img">
                                                                    <a asp-controller="Detail" asp-action="CarDetail" asp-route-Id="@car.Id">
                                                                        <img src="~/assets/images/cars/@VBcar.CarPhotos.FirstOrDefault(cp=>cp.CarId == car.Id).Path" alt="">
                                                                    </a>
                                                                </div>
                                                                <div class="card-details w-100">
                                                                    <div class="card-body">
                                                                        <div class="body-head">
                                                                            <div class="title">
                                                                                <h3>
                                                                                    <a href="#" style="background:white;">@VBcar.Brand.Name @VBcar.Brand.Models.FirstOrDefault(m=>m.Id == car.ModelId).Name</a>
                                                                                </h3>
                                                                                <h6>
                                                                                    Brand:
                                                                                    <span>@VBcar.Brand.Name</span>
                                                                                </h6>
                                                                            </div>
                                                                            <div class="price-rating">
                                                                                <div class="rating">
                                                                                    @for (double i = 0; i < Math.Floor((double)VBcar.Rating / ratings.Where(r => r.Comment.CarId == car.Id).Count()); i++)
                                                                                    {
                                                                                        <i class="fa-solid fa-star"></i>
                                                                                    }
                                                                                    @for (double i = 0; i < 5 - Math.Floor((double)VBcar.Rating / ratings.Where(r => r.Comment.CarId == car.Id).Count()); i++)
                                                                                    {
                                                                                        <i class="fa-solid fa-star" style="color: gray;"></i>
                                                                                    }

                                                                                    @if (ratings.Where(r => r.Comment.CarId == VBcar.Id).Count() > 0)
                                                                                    {
                                                                                        <span>@(((double)VBcar.Rating / ratings.Where(r => r.Comment.CarId == car.Id).Count()).ToString("F1"))</span>
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <span>@(VBcar.Rating).0</span>
                                                                                    }
                                                                                </div>
                                                                                <h6 class="price">
                                                                                    $@(car.Price.ToString("N0"))
                                                                                    <span>/ Day</span>
                                                                                </h6>
                                                                            </div>
                                                                        </div>
                                                                        <div class="body-mid">
                                                                            <ul>
                                                                                <li>
                                                                                    <img src="~/assets/images/index/cars/car-detail/car-parts-01.svg" alt="">
                                                                                    <p>@VBcar.Transmission.Name</p>
                                                                                </li>
                                                                                <li>
                                                                                    <img src="~/assets/images/index/cars/car-detail/car-parts-02.svg" alt="">
                                                                                    <p>@VBcar.Speed (km/ph)</p>
                                                                                </li>
                                                                                <li>
                                                                                    <img src="~/assets/images/index/cars/car-detail/car-parts-03.svg" alt="">
                                                                                    <p>@VBcar.FuelType.Name</p>
                                                                                </li>
                                                                                <li>
                                                                                    <img src="~/assets/images/index/cars/car-detail/car-parts-04.svg" alt="">
                                                                                    <p>@VBcar.Year</p>
                                                                                </li>
                                                                                <li>
                                                                                    <img src="~/assets/images/index/cars/car-detail/car-parts-05.svg" alt="">
                                                                                    <p>@VBcar.Engine.HorsePower</p>
                                                                                </li>
                                                                                <li>
                                                                                    <img src="~/assets/images/index/cars/car-detail/car-parts-06.svg" alt="">
                                                                                    <p>@VBcar.Capacity</p>
                                                                                </li>
                                                                            </ul>
                                                                        </div>
                                                                        <div class="body-bottom">
                                                                            <div class="author">
                                                                                <div class="author-img" style="border:1px solid gray;border-radius:50%;width:46px;height:46px;padding:2px; display:flex;align-items:center">
                                                                                    @if (VBcar.Company.CompanyPhoto != null)
                                                                                    {
                                                                                        <img src="~/assets/images/users/@VBcar.Company.CompanyPhoto" style="width:100%;height:100%" alt="owner-img">
                                                                                    }
                                                                                    else
                                                                                    {
                                                                                        <img src="~/assets/images/users/Default_pfp.svg.png" style="width:100%;height:100%" alt="owner-img">
                                                                                    }
                                                                                </div>
                                                                                <div class="author-name-location" style="margin-left:30px">
                                                                                    <div class="author-name">
                                                                                        <h5 style="text-align:start;">
                                                                                            <a href="#" style="background:white;">
                                                                                                @Model.CompanyName
                                                                                            </a>
                                                                                        </h5>
                                                                                        <h6>
                                                                                            <i class="fa-sharp fa-solid fa-location-dot"></i>
                                                                                            Newyork, USA
                                                                                        </h6>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="pending-body d-none">
                                    <div class="row">
                                        @if (@Model.Cars.Where(c => c.CarStatus == CarStatus.Pending).Count() == 0)
                                        {
                                            <p>There is no rented car</p>
                                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 122.88 98.75" style="enable-background:new 0 0 122.88 98.75" xml:space="preserve"><style type="text/css">                                                                                                                                                                                                                    }</style><g><path class="st0" d="M76.71,23.6l15.76,15.97v7.51l-7.46,0v-5.65h-6.18v-6.18h-5.91l-1.71-5.57c-2.72,1.82-6.03,2.88-9.58,2.88 c-9.32,0-16.88-7.29-16.88-16.28C44.75,7.29,52.31,0,61.63,0c9.32,0,16.88,7.29,16.88,16.28C78.51,18.91,77.86,21.4,76.71,23.6 L76.71,23.6L76.71,23.6z M0,45.47h24.83v44.18H0V45.47L0,45.47z M29.83,85.94V49.02h16.61c7.04,1.26,14.08,5.08,21.12,9.51h12.9 c5.84,0.35,8.9,6.27,3.22,10.16c-4.53,3.32-10.49,3.13-16.61,2.58c-4.22-0.21-4.4,5.46,0,5.48c1.53,0.12,3.19-0.24,4.64-0.24 c7.63-0.01,13.92-1.47,17.77-7.5l1.93-4.51l19.19-9.51c9.6-3.16,16.42,6.88,9.35,13.87C106.06,78.96,91.81,87.28,77.23,94 c-10.59,6.44-21.18,6.22-31.76,0L29.83,85.94L29.83,85.94z M59.2,11.07c1.66,0,3.01,1.35,3.01,3.01c0,1.66-1.35,3.01-3.01,3.01 c-1.67,0-3.01-1.35-3.01-3.01C56.19,12.41,57.54,11.07,59.2,11.07L59.2,11.07z" /></g></svg>
                                        }
                                        @foreach (Order order in Model.Orders)
                                        {
                                            <div class="bg-secondary p-3">
                                                <a asp-controller="Detail" asp-action="CarDetail" asp-route-Id="@order.Car.Id" class="row align-items-center text-white text-decoration-none">
                                                    <p class="col-lg-4 text-white">Consumer: @order.User.Name @order.User.Surname</p>
                                                    <p class="col-lg-3 text-white">Car: @order.Car.Brand.Name @order.Car.Brand.Models.FirstOrDefault(m=>m.Id == order.Car.ModelId).Name</p>
                                                    <p class="col-lg-3 text-white">Price: $@order.Car.Price</p>
                                                    <div class="col-lg-2 d-flex justify-content-between">
                                                    </div>
                                                </a>
                                                <form asp-controller="Rent" asp-action="AcceptOrder">
                                                    <input type="hidden" name="carId" value="@order.Car.Id"/>
                                                    <input type="hidden" name="orderId" value="@order.Id"/>
                                                    <button asp-controller="Rent" asp-action="AcceptOrder" asp-route-userId="@order.User.Id" type="submit" class="btn btn-warning text-white">Accept</button>
                                                </form>
                                                <form asp-controller="Rent" asp-action="RejectOrder">
                                                    <input type="hidden" name="carId" value="@order.Car.Id" />
                                                    <input type="hidden" name="orderId" value="@order.Id" />
                                                    <button asp-controller="Rent" asp-action="RejectOrder" asp-route-userId="@order.User.Id" class="btn btn-dark">Reject</button>
                                                </form>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="rented-body d-none">
                                    @if (@Model.Cars.Where(c => c.CarStatus == CarStatus.Rented).Count() == 0)
                                    {
                                        <p>There is no rented car</p>
                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" viewBox="0 0 122.88 98.75" style="enable-background:new 0 0 122.88 98.75" xml:space="preserve"><style type="text/css">                                                                                                                                                                                                                    }</style><g><path class="st0" d="M76.71,23.6l15.76,15.97v7.51l-7.46,0v-5.65h-6.18v-6.18h-5.91l-1.71-5.57c-2.72,1.82-6.03,2.88-9.58,2.88 c-9.32,0-16.88-7.29-16.88-16.28C44.75,7.29,52.31,0,61.63,0c9.32,0,16.88,7.29,16.88,16.28C78.51,18.91,77.86,21.4,76.71,23.6 L76.71,23.6L76.71,23.6z M0,45.47h24.83v44.18H0V45.47L0,45.47z M29.83,85.94V49.02h16.61c7.04,1.26,14.08,5.08,21.12,9.51h12.9 c5.84,0.35,8.9,6.27,3.22,10.16c-4.53,3.32-10.49,3.13-16.61,2.58c-4.22-0.21-4.4,5.46,0,5.48c1.53,0.12,3.19-0.24,4.64-0.24 c7.63-0.01,13.92-1.47,17.77-7.5l1.93-4.51l19.19-9.51c9.6-3.16,16.42,6.88,9.35,13.87C106.06,78.96,91.81,87.28,77.23,94 c-10.59,6.44-21.18,6.22-31.76,0L29.83,85.94L29.83,85.94z M59.2,11.07c1.66,0,3.01,1.35,3.01,3.01c0,1.66-1.35,3.01-3.01,3.01 c-1.67,0-3.01-1.35-3.01-3.01C56.19,12.41,57.54,11.07,59.2,11.07L59.2,11.07z" /></g></svg>
                                    }
                                    <div class="row">
                                        @foreach (Booking booking  in Model.Bookings)
                                        {
                                            <div class="bg-secondary p-3">
                                                <a asp-controller="Detail" asp-action="CarDetail" asp-route-Id="@booking.car.Id" class="row align-items-center text-white text-decoration-none">
                                                    <p class="col-lg-4 text-white">Consumer: @booking.User.Name @booking.User.Surname</p>
                                                    <p class="col-lg-3 text-white">Car: @booking.car.Brand.Name @booking.car.Brand.Models.FirstOrDefault(m=>m.Id == booking.car.ModelId).Name</p>
                                                    <p class="col-lg-3 text-white">Price: $@booking.car.Price</p>
                                                    <div class="col-lg-2 d-flex justify-content-between">
                                                    </div>
                                                </a>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<!-- main end -->

<!-- scripts -->
<script src="~/assets/js/companyaccount.js"></script>
